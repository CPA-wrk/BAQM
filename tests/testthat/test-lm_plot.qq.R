test_options <- list(scipen = 2, digits = 6, width = 90, max.print = 10000)

test_that("lm_plot.qq produces expected plot elements for cars", {
  withr::local_options(test_options)
  fit <- lm(formula = mpg ~ disp + drat, data = mtcars)
  set.seed(123)
  lm_plot.qq_cars <- lm_plot.qq(mdl = fit, opt = list(pval.SW = TRUE))
  # Delete plot graphics and mdl from output for test
  lm_plot.qq_cars.out <- list()
  nms <- names(lm_plot.qq_cars)
  for (nm in nms[!nms %in% c("mdl", "plts", "p_4way")]) {
    lm_plot.qq_cars.out[[nm]] <-
      testthat::capture_output_lines(print(lm_plot.qq_cars[[nm]]))
  }
  # lm_plot.qq_cars.txt <- lm_plot.qq_cars.out
  # dump("lm_plot.qq_cars.txt", file = "chk/lm_plot.qq_cars.txt")
  lm_plot.qq_cars.txt <- list(
    opt = c("$pval.SW", "[1] TRUE", ""),
    parm = c("$pts", "$pts$symsz",
             "[1] 1.5", "", "$pts$lblsz", "[1] 2.25", "", "$pts$shape", "$pts$shape$reg",
             "[1] \"circle\"", "", "$pts$shape$outl", "[1] \"circle open\"",
             "", "$pts$shape$cook", "[1] \"square open\"", "", "", "$pts$colr",
             "$pts$colr$reg", "[1] \"black\"", "", "$pts$colr$outl", "[1] \"red\"",
             "", "$pts$colr$cook", "[1] \"green4\"", "", "$pts$colr$infl",
             "[1] \"green4\"", "", "", "$pts$id", "$pts$id$reg", "[1] FALSE",
             "", "$pts$id$outl", "[1] TRUE", "", "$pts$id$cook", "[1] TRUE",
             "", "$pts$id$infl", "[1] TRUE", "", "", "$pts$offp", "$pts$offp$infl",
             "[1] 0.01", "", "", "", "$lins", "$lins$size", "[1] 0.5", "",
             "$lins$size_lg", "[1] 1", "", "$lins$notesz", "[1] 3.5", "",
             "$lins$ltyp", "$lins$ltyp$fit", "[1] \"solid\"", "", "$lins$ltyp$pi",
             "[1] \"dashed\"", "", "$lins$ltyp$qq", "[1] \"solid\"", "", "$lins$ltyp$var",
             "[1] \"dashed\"", "", "$lins$ltyp$ac", "[1] \"solid\"", "", "$lins$ltyp$lev",
             "[1] \"dotted\"", "", "$lins$ltyp$infl", "[1] \"dotted\"", "",
             "$lins$ltyp$cook", "[1] \"dotted\"", "", "", "$lins$colr", "$lins$colr$fit",
             "[1] \"orange\"", "", "$lins$colr$qq", "[1] \"dodgerblue\"",
             "", "$lins$colr$var", "[1] \"purple\"", "", "$lins$colr$ac",
             "[1] \"green4\"", "", "$lins$colr$lev", "[1] \"green4\"", "",
             "$lins$colr$infl", "[1] \"green4\"", "", "$lins$colr$cook", "[1] \"gray70\"",
             "", "", "", "$seed", "$seed$ac", "$seed$ac$outl", "[1] 123",
             "", "$seed$ac$reg", "[1] 123", "", "", "$seed$fit", "$seed$fit$outl",
             "[1] 123", "", "$seed$fit$reg", "[1] 123", "", "", "$seed$infl",
             "$seed$infl$infl", "[1] 123", "", "$seed$infl$outl", "[1] 123",
             "", "$seed$infl$reg", "[1] 123", "", "", "$seed$lev", "$seed$lev$lev",
             "[1] 123", "", "$seed$lev$outl", "[1] 123", "", "$seed$lev$reg",
             "[1] 123", "", "", "$seed$qq", "$seed$qq$outl", "[1] 123", "",
             "$seed$qq$reg", "[1] 123", "", "", "$seed$var", "$seed$var$outl",
             "[1] 123", "", "$seed$var$reg", "[1] 123", "", "", "", "$cook",
             "$cook$n", "[1] 100", "", "$cook$level", "[1] 0.5 1.0", "", "",
             "$xtrem", "$xtrem$infl", "$xtrem$infl$meas", "[1] \".cooksd\"",
             "", "$xtrem$infl$thrshld", "[1] 0.807525", "", "", "$xtrem$lev",
             "$xtrem$lev$meas", "[1] \".hat\"", "", "$xtrem$lev$thrshld",
             "[1] 0.1875", "", "", "$xtrem$outl", "$xtrem$outl$meas", "[1] \"boxplot\"",
             "", "$xtrem$outl$thrshld", "[1] 1.5", "", "", "", "$qq", "$qq$lim",
             "           x        y", "min -2.15387 -5.12653", "max  2.15387  6.98840",
             "", "$qq$qqlin", "$qq$qqlin$probs", "[1] 0.25 0.75", "", "$qq$qqlin$theory",
             "[1] -0.67449  0.67449", "", "$qq$qqlin$resid", "[1] -2.20451  1.44974",
             "", "$qq$qqlin$slope", "[1] 2.70889", "", "$qq$qqlin$int", "[1] -0.377385",
             "", "", "$qq$SW", "", "\tShapiro-Wilk normality test", "", "data:  df$.resid",
             "W = 0.9325, p-value = 0.046", "", "", ""),
    df = c("                                    .id .sequence .obs   .fits     .resid",
           "Mazda RX4                     Mazda RX4         1 21.0 23.1618 -2.1617659",
           "Mazda RX4 Wag             Mazda RX4 Wag         2 21.0 23.1618 -2.1617659",
           "Datsun 710                   Datsun 710         3 22.8 24.9277 -2.1277463",
           "Hornet 4 Drive           Hornet 4 Drive         4 21.4 18.1861  3.2138969",
           "Hornet Sportabout     Hornet Sportabout         5 18.7 14.6715  4.0285308",
           "Valiant                         Valiant         6 18.1 18.7874 -0.6873524",
           "Duster 360                   Duster 360         7 14.3 14.7796 -0.4795908",
           "Merc 240D                     Merc 240D         8 24.4 23.2581  1.1419313",
           "Merc 230                       Merc 230         9 22.8 23.8831 -1.0831289",
           "Merc 280                       Merc 280        10 19.2 22.9265 -3.7265329",
           "Merc 280C                     Merc 280C        11 17.8 22.9265 -5.1265329",
           "Merc 450SE                   Merc 450SE        12 16.4 17.5327 -1.1327317",
           "Merc 450SL                   Merc 450SL        13 17.3 17.5327 -0.2327317",
           "Merc 450SLC                 Merc 450SLC        14 15.2 17.5327 -2.3327317",
           "Cadillac Fleetwood   Cadillac Fleetwood        15 10.4 10.2773  0.1226915",
           "Lincoln Continental Lincoln Continental        16 10.4 10.8318 -0.4317770",
           "Chrysler Imperial     Chrysler Imperial        17 14.7 11.9601  2.7398791",
           "Fiat 128                       Fiat 128        18 32.4 26.3880  6.0119567",
           "Honda Civic                 Honda Civic        19 30.4 28.0268  2.3731518",
           "Toyota Corolla           Toyota Corolla        20 33.9 26.9116  6.9883994",
           "Toyota Corona             Toyota Corona        21 21.5 24.2255 -2.7255462",
           "Dodge Challenger       Dodge Challenger        22 15.5 15.4678  0.0321785",
           "AMC Javelin                 AMC Javelin        23 15.2 16.6703 -1.4703265",
           "Camaro Z28                   Camaro Z28        24 13.3 16.0736 -2.7735839",
           "Pontiac Firebird       Pontiac Firebird        25 19.2 13.1176  6.0824280",
           "Fiat X1-9                     Fiat X1-9        26 27.3 26.3773  0.9226649",
           "Porsche 914-2             Porsche 914-2        27 26.0 25.5339  0.4661126",
           "Lotus Europa               Lotus Europa        28 30.4 25.2440  5.1559649",
           "Ford Pantera L           Ford Pantera L        29 15.8 16.9209 -1.1208834",
           "Ferrari Dino               Ferrari Dino        30 19.7 23.1926 -3.4926064",
           "Maserati Bora             Maserati Bora        31 15.0 17.4802 -2.4801988",
           "Volvo 142E                   Volvo 142E        32 21.4 24.9323 -3.5322530",
           "                     .se.fit .lower.pi .upper.pi .std.resid .stud.resid",
           "Mazda RX4           0.673795  16.40981   29.9137 -0.6839287  -0.6775196",
           "Mazda RX4 Wag       0.673795  16.40981   29.9137 -0.6839287  -0.6775196",
           "Datsun 710          0.832145  18.10233   31.7532 -0.6813463  -0.6749198",
           "Hornet 4 Drive      0.888000  11.33131   25.0409  1.0342606   1.0355502",
           "Hornet Sportabout   0.836083   7.84404   21.4989  1.2904497   1.3060585",
           "Valiant             1.435912  11.55448   26.0202 -0.2374016  -0.2334995",
           "Duster 360          0.832583   7.95395   21.6052 -0.1535802  -0.1509704",
           "Merc 240D           0.738378  16.47793   30.0382  0.3629389   0.3574392",
           "Merc 230            0.713594  17.11410   30.6522 -0.3436258  -0.3383388",
           "Merc 280            0.673797  16.17458   29.6785 -1.1789821  -1.1872796",
           "Merc 280C           0.673797  16.17458   29.6785 -1.6219072  -1.6713013",
           "Merc 450SE          0.854280  10.69588   24.3696 -0.3634192  -0.3579144",
           "Merc 450SL          0.854280  10.69588   24.3696 -0.0746683  -0.0733767",
           "Merc 450SLC         0.854280  10.69588   24.3696 -0.7484205  -0.7426102",
           "Cadillac Fleetwood  1.271165   3.17457   17.3800  0.0412917   0.0405747",
           "Lincoln Continental 1.227241   3.76143   17.9021 -0.1444194  -0.1419586",
           "Chrysler Imperial   1.210962   4.90152   19.0187  0.9143979   0.9117337",
           "Fiat 128            0.913263  19.51938   33.2567  1.9392760   2.0425879",
           "Honda Civic         1.614325  20.63829   35.4154  0.8476272   0.8433978",
           "Toyota Corolla      0.963429  20.01433   33.8089  2.2653701   2.4536311",
           "Toyota Corona       0.852463  17.38965   31.0614 -0.8743093  -0.8706543",
           "Dodge Challenger    1.124191   8.46952   22.4661  0.0106200   0.0104353",
           "AMC Javelin         0.749282   9.88518   23.4555 -0.4676958  -0.4613044",
           "Camaro Z28          1.109209   9.08529   23.0619 -0.9137112  -0.9110288",
           "Pontiac Firebird    0.977206   6.21220   20.0229  1.9744644   2.0853481",
           "Fiat X1-9           0.912212  19.50925   33.2454  0.2975942   0.2928657",
           "Porsche 914-2       1.084800  18.56164   32.5061  0.1531088   0.1505067",
           "Lotus Europa        0.932317  18.36467   32.1234  1.6662099   1.7217154",
           "Ford Pantera L      1.727329   9.42620   24.4156 -0.4103563  -0.4043949",
           "Ferrari Dino        0.789712  16.38831   29.9969 -1.1144760  -1.1193247",
           "Maserati Bora       0.703328  10.71566   24.2447 -0.7862750  -0.7809688",
           "Volvo 142E          0.815586  18.11520   31.7493 -1.1295181  -1.1351226",
           "                          .cooksd      .hat  .quantile .is.outl .is.infl",
           "Mazda RX4           0.00708532451 0.0434670 -0.6260990      reg      reg",
           "Mazda RX4 Wag       0.00708532451 0.0434670 -0.5334097      reg      reg",
           "Datsun 710          0.01098775493 0.0662983 -0.4450965      reg      reg",
           "Hornet 4 Drive      0.02911794584 0.0754971  0.9467818      reg      reg",
           "Hornet Sportabout   0.03981515074 0.0669272  1.0775156      reg      reg",
           "Valiant             0.00462072025 0.1974058 -0.0391761      reg      reg",
           "Duster 360          0.00055889795 0.0663681  0.0391761      reg      reg",
           "Merc 240D           0.00241819157 0.0521990  0.6260990      reg      reg",
           "Merc 230            0.00201727123 0.0487536 -0.1177699      reg      reg",
           "Merc 280            0.02105504975 0.0434673 -1.6759397      reg      reg",
           "Merc 280C           0.03984683665 0.0434673 -2.1538747      reg      reg",
           "Merc 450SE          0.00330717202 0.0698723 -0.2776904      reg      reg",
           "Merc 450SL          0.00013960915 0.0698723  0.1970991      reg      reg",
           "Merc 450SLC         0.01402594861 0.0698723 -0.7245144      reg      reg",
           "Cadillac Fleetwood  0.00010401706 0.1547063  0.3601299      reg      reg",
           "Lincoln Continental 0.00117144308 0.1441996  0.1177699      reg      reg",
           "Chrysler Imperial   0.04552163290 0.1403994  0.8305109      reg      reg",
           "Fiat 128            0.10879213093 0.0798539  1.4177971      reg      reg",
           "Honda Civic         0.07962124800 0.2495089  0.7245144      reg      reg",
           "Toyota Corolla      0.16684754860 0.0888677  2.1538747     outl     outl",
           "Toyota Corona       0.01905385738 0.0695753 -0.9467818      reg      reg",
           "Dodge Challenger    0.00000517514 0.1209998  0.2776904      reg      reg",
           "AMC Javelin         0.00414186118 0.0537520 -0.3601299      reg      reg",
           "Camaro Z28          0.03715853911 0.1177961 -1.0775156      reg      reg",
           "Pontiac Firebird    0.13076575679 0.0914274  1.6759397      reg      reg",
           "Fiat X1-9           0.00255552223 0.0796702  0.5334097      reg      reg",
           "Porsche 914-2       0.00099219522 0.1126689  0.4450965      reg      reg",
           "Lotus Europa        0.08400489568 0.0832207  1.2298588      reg      reg",
           "Ford Pantera L      0.02244669903 0.2856633 -0.1970991      reg      reg",
           "Ferrari Dino        0.02629053664 0.0597092 -1.2298588      reg      reg",
           "Maserati Bora       0.01024516517 0.0473609 -0.8305109      reg      reg",
           "Volvo 142E          0.02892591474 0.0636859 -1.4177971      reg      reg",
           "                    .is.lev", "Mazda RX4               reg",
           "Mazda RX4 Wag           reg", "Datsun 710              reg",
           "Hornet 4 Drive          reg", "Hornet Sportabout       reg",
           "Valiant                 lev", "Duster 360              reg",
           "Merc 240D               reg", "Merc 230                reg",
           "Merc 280                reg", "Merc 280C               reg",
           "Merc 450SE              reg", "Merc 450SL              reg",
           "Merc 450SLC             reg", "Cadillac Fleetwood      reg",
           "Lincoln Continental     reg", "Chrysler Imperial       reg",
           "Fiat 128                reg", "Honda Civic             lev",
           "Toyota Corolla         outl", "Toyota Corona           reg",
           "Dodge Challenger        reg", "AMC Javelin             reg",
           "Camaro Z28              reg", "Pontiac Firebird        reg",
           "Fiat X1-9               reg", "Porsche 914-2           reg",
           "Lotus Europa            reg", "Ford Pantera L          lev",
           "Ferrari Dino            reg", "Maserati Bora           reg",
           "Volvo 142E              reg"))
  expect_equal(lm_plot.qq_cars.out, lm_plot.qq_cars.txt)
})
